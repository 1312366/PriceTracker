USE [PriceTracker]
GO
/****** Object:  StoredProcedure [dbo].[GET_SUGGEST_URLS]    Script Date: 06/01/2018 1:22:11 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[GET_SUGGEST_URLS](
	@P_URL VARCHAR(2000))
	AS
BEGIN
	SELECT TOP 4 T.PRODUCT_LINK
	FROM(
		SELECT PRODUCT_LINK,COUNT(*) AS NUMBER
		FROM(
			SELECT DISTINCT(SESSION_ID) AS SESSION_ID
			FROM SESSION_REQUEST
			WHERE PRODUCT_LINK=@P_URL) AS S1,SESSION_REQUEST AS S2
		WHERE S1.SESSION_ID=S2.SESSION_ID AND S2.PRODUCT_LINK!=@P_URL
		GROUP BY PRODUCT_LINK) AS T
	ORDER BY T.NUMBER DESC;
END
USE [PriceTracker]
GO
/****** Object:  StoredProcedure [dbo].[getHistoryPrice]    Script Date: 06/01/2018 1:22:28 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[getHistoryPrice](  
    @P_LINK VARCHAR(2000))
AS 
begin
	SELECT PRODUCT_TYPE_1 ,
	PRODUCT_TYPE_2 ,
	PRODUCT_TYPE_3 ,
	PRODUCT_TYPE_4 ,
	PRODUCT_PRICE ,
	DATE_UPDATED 
	FROM PRODUCTS_PRICE
	WHERE PRODUCT_LINK=@P_LINK
end


USE [PriceTracker]
GO
/****** Object:  StoredProcedure [dbo].[getPriceProduct]    Script Date: 06/01/2018 1:22:55 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[getPriceProduct](  
    @P_LINK VARCHAR(2000))
AS 
begin
select AVG(PRODUCT_PRICE) as PRODUCT_PRICE , '' as DATE_UPDATED
from PRODUCTS_PRICE
where PRODUCT_LINK=@P_LINK
union all
select * from
(select top 1 PRODUCT_PRICE,DATE_UPDATED
from PRODUCTS_PRICE
where PRODUCT_LINK=@P_LINK
order by PRODUCT_PRICE desc) as a
union all
select * from(
select top 1 PRODUCT_PRICE,DATE_UPDATED
from PRODUCTS_PRICE
where PRODUCT_LINK=@P_LINK
order by PRODUCT_PRICE asc) as b
end



USE [PriceTracker]
GO
/****** Object:  StoredProcedure [dbo].[INSERT_PRODUCT_PRICE]    Script Date: 06/01/2018 1:23:06 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[INSERT_PRODUCT_PRICE](  
    @P_PRICE INT,
	@P_LINK VARCHAR(2000))
AS 
begin
declare @PRICE int;
set @PRICE=(select top 1 PRODUCT_PRICE
from PRODUCTs_PRICE
where PRODUCT_LINK=@P_LINK
order by DATE_UPDATED desc)
if ( @PRICE is null or @P_PRICE!=@PRICE )
BEGIN
	INSERT INTO PRODUCTS_PRICE(PRODUCT_LINK,PRODUCT_PRICE,DATE_UPDATED) VALUES(@P_LINK,@P_PRICE,GETDATE());
END
END;

USE [PriceTracker]
GO
/****** Object:  StoredProcedure [dbo].[saveUserRequest]    Script Date: 06/01/2018 1:23:35 AM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[saveUserRequest](  
    @P_SESSION_ID INT,
	@P_URL VARCHAR(2000))
AS 
begin
	DECLARE @SID INT;
	DECLARE @ISEXISTS INT;
	SET @SID= (SELECT MAX(SESSION_REQUEST.SESSION_ID) FROM  SESSION_REQUEST)+1;
	IF(@P_SESSION_ID>0)
	BEGIN
		SET @SID=@P_SESSION_ID;
	END;
	SET @ISEXISTS=(SELECT COUNT(*) FROM SESSION_REQUEST WHERE SESSION_ID=@SID AND @P_URL=PRODUCT_LINK );
	IF(@ISEXISTS=0)
	BEGIN
	INSERT INTO SESSION_REQUEST(SESSION_ID,PRODUCT_LINK,DATE_UPDATED) VALUES(@SID,@P_URL,GETDATE());
	END;
	SELECT @SID AS RESULT;
END